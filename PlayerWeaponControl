using UnityEngine;
using System.Collections;

public class PlayerWeaponControl : MonoBehaviour 
{
	public WeaponBase[] weapons; // Необходим проинициализировать через инспектор иначе ошибка
	public Transform weaponSlot;
	
	public int activeWeaponIndex = 0;
	
	public GameObject nullWeaponPrefab;
	
	// Use this for initialization
	void Start () 
	{
		for (int i=0; i < weapons.Length; i++)
		{
			activeWeaponIndex = i;

			if( weapons[activeWeaponIndex] == null)
			{
				SetWeapon(nullWeaponPrefab);
			}
		}
		
		activeWeaponIndex = 0;
	}
	
	// Update is called once per frame
	void Update () 
	{
		if( Input.GetButton("Fire1") )
		{
			weapons[ activeWeaponIndex ].Shoot();
		}

		if( Input.GetButtonDown("Change Weapon") )
		{
			ChangeWeapon();
		}

		if( Input.GetButtonDown("Reload") )
		{
			weapons[ activeWeaponIndex ].Reload();
		}


	}
	
	public void ChangeWeapon()
	{
		weapons[activeWeaponIndex].SwitchWeaponOut();
		
		activeWeaponIndex += 1;
		
		if(activeWeaponIndex >= weapons.Length)
		{
			activeWeaponIndex = 0;
		}
		
		weapons[activeWeaponIndex].SwitchWeaponOnThis();
	}
	
	public void SetWeapon ( GameObject weapon )
	{
		GameObject newWeapon = Instantiate(weapon, transform.position, weaponSlot.rotation) as GameObject;
		newWeapon.transform.parent = weaponSlot.transform; 
		
		if( weapons[activeWeaponIndex] != null )
		{
			Destroy ( weapons[activeWeaponIndex].gameObject );
		}
		weapons[activeWeaponIndex] = newWeapon.GetComponent<WeaponBase>();
		
	}
	
	public void TakeAmmo ( AmmoPickable ammo )
	{
		//Конечно можно добавить проверку, чтобы сначало для активного оружия патроны прибавлялись
		//Но это создаст проблему только если игрок имеет 2 одинаковых оружия или оружие с одинаковым
		//типом патронов, что ПОКА не актуально
		foreach ( WeaponBase weapon in weapons )
		{
			bool isCorrectWeaponFind = weapon.TakeAmmo(ammo.caliber, ammo.amount);

			if( isCorrectWeaponFind )
			{
				break;
			}
		}
	}
	
	void OnGUI()
	{
		GUILayout.Label( weapons[activeWeaponIndex].GetStatus() );
	}
}
